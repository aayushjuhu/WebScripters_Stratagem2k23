<!DOCTYPE html>
<html>
	<head>
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
		/>
		<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.slim.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="/css/cam.css">
		<title>Live Photo Capture</title>
		<meta charset="utf-8" />
	</head>
	<body style="background-image: url(/images/background.jpg)">
		
    <div class="head">Click Image To Proceed</div>

    <div class="cam">
      <video id="video" width="640" height="480" autoplay></video>
      <canvas id="canvas" width="640" height="480"></canvas>
    </div>
    <div class="capture">
      <button id="capture-btn">Capture</button>
    </div>

		<script>
			const video = document.getElementById("video");
			const canvas = document.getElementById("canvas");
			const captureBtn = document.getElementById("capture-btn");
			const backendUrl = "http://localhost:3000/upload-photo/<%=id%>";

			navigator.mediaDevices
				.getUserMedia({ video: true })
				.then(stream => {
					video.srcObject = stream;
					video.play();
				});

			captureBtn.addEventListener("click", () => {
				const context = canvas.getContext("2d");
				context.drawImage(video, 0, 0, canvas.width, canvas.height);
				const dataUrl = canvas.toDataURL("image/jpeg");
				const blob = dataURItoBlob(dataUrl);
				sendPhoto(blob);
			});

			function sendPhoto(photo) {
				const formData = new FormData();
				formData.append("photo", photo);
				fetch(backendUrl, { method: "POST", body: formData })
					.then(response => {
						if (response.status == 200) {
							window.location.href =
								"http://localhost:3000/dashboard";
						} else {
							console.log("Match not found");
						}
					})
					.catch(error => {
						console.error("Error uploading photo:", error);
					});
			}

			function dataURItoBlob(dataURI) {
				const byteString = atob(dataURI.split(",")[1]);
				const mimeString = dataURI
					.split(",")[0]
					.split(":")[1]
					.split(";")[0];
				const arrayBuffer = new ArrayBuffer(byteString.length);
				const byteArray = new Uint8Array(arrayBuffer);
				for (let i = 0; i < byteString.length; i++) {
					byteArray[i] = byteString.charCodeAt(i);
				}
				return new Blob([arrayBuffer], { type: mimeString });
			}
		</script>
	</body>
</html>
